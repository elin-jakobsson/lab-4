<!DOCTYPE html>
<html>

<head>
  <!--Meta Data-->
  <meta charset="utf-8">
  <title>Lab 4</title>
  <!--Bootstrap-->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
  <!--FONT Awsome-->
  <link href="resources/font-awesome-4.7.0/css/font-awesome.css" rel="stylesheet">
  <!--Css Egen-->
  <style>
    * {
      margin: 0;
      padding: 0;

    }

    header {
      height: 20vh;
      width: 100vw;
      background-color: powderBlue;
      text-align: center;
      font-family: monospace;
    }

    header>h1 {
      position: relative;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }

    body {
      background-color: #f4f4f4;
      margin: auto;
    }

    .container div,
    .container>button {
      display: block;
      margin: 10px;
      padding: 5px;
      left: 30px;

    }

    #output {
      cursor: pointer;

      width: 100%
    }

    .bookEx {
      float: left;
      display: inline-block;
      text-align: center;
      width: 30%;

      margin: 10px;
      background-color: white;
      border-radius: 10px;
    }

    .bookEx>* {

      list-style-type: none;
    }

    .bookSaved {
      display: inline-block;
      text-align: center;
      width: 30%;

      margin: 10px;
      background-color: white;
      border-radius: 10px;
    }

    .bookSaved>* {

      list-style-type: none;
    }

    #viewDiv.hidden {
      display: none;
    }

    #viewDiv.show {
      display: block;
    }

    #viewDiv>div {
      background-color: white;
      border-radius: 10px;
      width: 100%;
      margin: 5px 0;
      padding: 10px;

    }

    #viewDiv ul {
      list-style: none;
    }

    .changeDiv {
      text-align: right;
      margin: 10px;
    }

    .error {

      max-height: 200px;
      width: 100%;
      bottom: 0px;

      overflow: auto;
      background-color: lightgray;
      padding: 30px;
      border-radius: 10px;
    }
  </style>
  <!--Script-->
  <script type="text/javascript">
    window.addEventListener("load", function(event) {
      let titleAdd = document.getElementById("addTitle");
      let authorAdd = document.getElementById("addAuthor");
      let errorMessage = document.getElementsByClassName('error')[0];
      let viewDiv = document.getElementById('viewDiv');
      let viewBtn = document.getElementById("viewBtn");
      let fails = 0;
      let imgList = [];

      let savedOutput;
      let keyAdd;
      let bookId;
      let bookImg;

      //JavaScript for google api
      let button = document.getElementById("addGoogleBtn");
      let input = document.getElementById("input");
      let output = document.getElementById("output");
      let bookTest;
      button.addEventListener("click", function(event) {
        let url = "https://www.googleapis.com/books/v1/volumes?q=" + input.value;
        console.log(url);

        fetch(url)
          .then(function(response) {
            return response.json()
          }, function(fail) {
            fails += 1;
            failMessage = ` <p> Google API-fetch fail Nr: ${fails} - message: soemthing went wrong</p> `
            errorMessage.innerHTML += failMessage;

          }).then(function(json) {
            console.log(json);
            output.innerHTML = '';
            bookTest = '';
            //googleBooksList = json.items;
            for (var i = 0; i < json.items.length; i++) {
              let img = json.items[i].volumeInfo.imageLinks.thumbnail;;
              imgList.push(img);
              bookTest +=
                `<div class="bookEx">
                  <ul>
                  <li> <img src=${img} alt="img not found"> </li>
                  <li> Title: ${json.items[i].volumeInfo.title}</li>
                  <li> Author: ${json.items[i].volumeInfo.authors}</li>
                  </ul>
                  <button class="btn btn-primary addBtn">Select Book</button>
                  </div>`;
            }
            output.innerHTML = bookTest;
            let btnList = document.getElementsByClassName('addBtn');
            console.log(btnList);
            for (var i = 0; i < btnList.length; i++) {
              btnList[i].addEventListener('click', function(event) {
                if (keyAdd == undefined) {
                  alert('You have to request a key before you can add book to your book sekection');
                } else {

                  let title = event.target.previousElementSibling.children[1].innerText;
                  console.log(title);
                  let author = event.target.previousElementSibling.children[2].innerText;
                  console.log(author);
                  event.target.parentElement.style.border = '2px solid green';
                  let urlAdd = "https://www.forverkliga.se/JavaScript/api/crud.php?op=insert" + "&key=" + keyAdd + "&title=" + title + "&author=" + author;

                  getAjax(urlAdd, addBook);
                  event.target.disabled = true;
                }

              })
            }
          }).catch((error) => {
            console.log(error);
            output.innerHTML = 'Sorry! Our book api was not able to fetch your book. Please try another search.';
          });
      });


      // JavaScript for school api

      document.getElementById("viewBtn").disabled = true;

      function getAjax(url, callback, num = 0) {
        let exe = function(success, fail) {
          fetch(url)
            .then((response) => response.json())
            .then((result) => {
              if (result.status !== "success") {
                fail(result);
              } else {
                success(result);
              }
            })
        };
        let promise = new Promise(exe);
        promise.then(function(success) {
          console.log(success);
          return success;
        }, function(fail) {
          console.log(fail);
          fails += 1;
          failMessage = ` <p> API-fetch fail Nr: ${fails} - message: ${fail.message}</p> `
          errorMessage.innerHTML += failMessage;
          if (num < 10) {
            console.log(num);
            getAjax(url, callback, num + 1);
          } else {
            alert(fail.message);
          }
        }).then(function(obj) {
          //console.log(obj);
          if (obj !== undefined) {
            callback(obj);
          }
        }).catch(function(error) {
          console.log(error);
        })
      }


      document.getElementById('requestKey').addEventListener("click", getKey);

      viewBtn.addEventListener("click", (event) => {
        if (viewDiv.className === 'hidden') {
          viewDiv.setAttribute('class', 'show')
          viewBtn.innerHTML = 'Show Booklist';
        } else {
          viewDiv.setAttribute('class', 'hidden')
          viewBtn.innerHTML = 'Hide Booklist';
        }

      });

          //let changeBtn = document.getElementById('changeBook');
          /*  viewDiv.children.addEventListener('click', function(event) {
              console.log(viewDiv.children);

              let spans = document.getElementsByClassName('spanToInput');
              console.log(spans);
              let inputValu = '';
              for (var i = 0; i < spans.length; i++) {
                span = spans[i];
                let input = document.createElement('input');
                input.className = 'testInput';
                input.setAttribute('value', inputValu);
                input.setAttribute('placeholder', span.innerText);
                span.parentNode.replaceChild(input, span);
              }
              console.log(span);
            });*/

      function getKey() {
        fetch("https://www.forverkliga.se/JavaScript/api/crud.php?requestKey")
          .then((response) => response.json())
          .then((dataKey) => {
            document.getElementById('keyText').innerHTML = dataKey.key;
            //document.getElementById("addBtn").disabled = false;
            keyAdd = dataKey.key;
          }).catch((error) => console.log(error))
      }

      function addBook(obj) {
        console.log(obj);
        document.getElementById("viewBtn").disabled = false;
        bookId = obj.id;
        let urlView = "https://www.forverkliga.se/JavaScript/api/crud.php?op=select" + "&key=" + keyAdd;
        getAjax(urlView, addToList);
      }

      function addToList(obj, count = 0) {
        console.log(obj);
        savedOutput = '';
        for (var i = 0; i < obj.data.length; i++) {

          savedOutput +=
            `<div class="bookSaved">
              <ul>
              <li> <img src=${imgList[i]} alt="img not found"> </li>
              <li> Title: <span class='spanBooks' id='title'>${obj.data[i].title}</span> </li>
              <li> Author: <span class='spanBooks' id='author'> ${obj.data[i].author} </span></li>
              <li> updated: id='updated'> ${obj.data[i].updated} </span></li>
              <li> Id: <span id='idNr'> ${obj.data[i].id} </span></li>
              </ul>
              <button id='${obj.data[i].id}' class="btn btn-danger deleteBtn">Delete</button>
              </div>`;
        }
        viewDiv.innerHTML = savedOutput;
        let deleteBtnList = document.getElementsByClassName('deleteBtn');
        let spanBooks = document.getElementsByClassName('spanBooks');

        for (var i = 0; i < deleteBtnList.length; i++) {
          deleteBtnList[i].addEventListener('click', function(event) {
            if (keyAdd == undefined) {
              alert('You have to request a key before you can add book to your book sekection');
            } else {
              let deleteUrl = "https://www.forverkliga.se/JavaScript/api/crud.php?op=delete" + "&key=" + keyAdd + "&id=" + event.target.id;
              getAjax(deleteUrl, function(obj){
                let node = event.target.parentElement;
                let parent = event.target.parentElement.parentElement;
                parent.removeChild(node);
              });
            }
          })
        }

        console.log('spanlist ', spanBooks.length);
        for (var i = 0; i < spanBooks.length; i++) {
          spanBooks[i].addEventListener('click', function(event) {
            if (keyAdd == undefined) {
              alert('You have to request a key before you can add book to your book sekection');
            } else {
              console.log(spanBooks[i]);
              /*let newInput = document.createElement('input');
              newInput.className = 'testInput';
              newInput.setAttribute('value', '');
              newInput.setAttribute('placeholder', 'new input');
            spanBooks[i].parentElement.replaceChild(newInput,spanBooks[i]);*/
              }
            })
          }
        }




      /*function changeBook() {
        let exe = function(success, fail) {


        };

          let url = "https://www.forverkliga.se/JavaScript/api/crud.php?op=update" + "&key=" + keyAdd + "&id=" + book.id + "&title=" + book.title + "&author=" + book.author;

          fetch(url)
            .then((response) => response.json())
            .then((result) => {
              if (result.status !== "success") {
                fail(result);
              } else {
                success(result);
              }
            })
        };
      };*/





    });
  </script>
</head>

<body>
  <!--HEADER-->
  <header>
    <h1>Lab 4 by Elin &amp; Anna</h1>
  </header>
  <!--MAIN-->
  <main>
    <div class="container">
      <div class="requestDiv">
        <button id="requestKey" class="btn btn-secondary" type="button" name="button">Request API key</button>
        <p>Received: <strong id="keyText"></strong></p>
      </div>

      <div class="googleBooks">
        <h4>Add a book from Google Books</h4>
        <input id="input" type="text" placeholder="Search Title or Author..." value="" />
        <button id="addGoogleBtn" class="btn btn-primary" type="button" name="button"><i class="fa fa-search" aria-hidden="true"></i></button>
        <br/>
        <div id="output" title="Add to the list">
        </div>
      </div>

      <div>
        <button id="viewBtn" class="btn btn-success" type="button" name="button">Show Booklist</button>
      </div>
      <div id="viewDiv" class="hidden">

      </div>

      <div class="error">
        <h5 class="error-message">API Fetch - Information </h5>
      </div>
    </div>
  </main>

  <!--FOOTER-->
  <footer>

  </footer>

</body>

</html>
